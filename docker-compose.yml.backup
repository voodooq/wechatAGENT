# OpenClaw å®Œæ•´ Docker é…ç½®
# 
# ç”¨é€”: åœ¨ WSL Docker ä¸­è¿è¡Œæ‰€æœ‰ OpenClaw æœåŠ¡
# åŒ…æ‹¬: HTTP Bridge Server + Bridge Worker
#
# ç½‘ç»œæ¶æ„:
#   - HTTP Bridge: ç«¯å£ 9848 (æš´éœ²ç»™ä¸»æœº)
#   - Worker: å†…éƒ¨è¿æ¥åˆ° Bridge
#   - IronSentinel (Windows) -> host.docker.internal:9848

version: '3.8'

services:
  # HTTP Bridge Server æœåŠ¡
  http-bridge:
    image: node:22
    container_name: openclaw-http-bridge
    
    # ç«¯å£æ˜ å°„: ä¸»æœº 9848 -> å®¹å™¨ 9848
    ports:
      - "9848:9848"
    
    # ç¯å¢ƒå˜é‡
    environment:
      - HTTP_BRIDGE_HOST=0.0.0.0
      - HTTP_BRIDGE_PORT=9848
      - PYTHONUNBUFFERED=1
    
    # æŒ‚è½½å·
    volumes:
      # æŒ‚è½½ wechat-agent ä»£ç 
      - /mnt/e/work/wechatAGENT:/home/node/openclaw/wechat-agent:rw
      
      # æŒ‚è½½ OpenClaw å·¥ä½œç›®å½•
      - /home/node/.openclaw:/home/node/.openclaw:rw
      
      # Python ç¼“å­˜
      - openclaw-pip-cache:/root/.cache/pip
    
    working_dir: /home/node/openclaw/wechat-agent
    
    # å¯åŠ¨å‘½ä»¤
    command: >
      sh -c "
        echo '========================================' &&
        echo '  OpenClaw HTTP Bridge Server' &&
        echo '  è¿è¡Œåœ¨ Docker ä¸­' &&
        echo '========================================' &&
        echo '' &&
        echo 'ğŸ“¦ å®‰è£… Python ä¾èµ–...' &&
        apt-get update -qq &&
        apt-get install -y -qq python3 python3-pip 2>/dev/null &&
        pip3 install -q fastapi uvicorn pydantic aiohttp 2>/dev/null &&
        echo '' &&
        echo 'ğŸš€ å¯åŠ¨ HTTP Bridge Server...' &&
        echo '   ç«¯å£: 9848' &&
        echo '   è®¿é—®: http://localhost:9848' &&
        echo '' &&
        python3 http_bridge_server.py
      "
    
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9848/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    restart: unless-stopped
    
    # ç½‘ç»œé…ç½®
    networks:
      - openclaw-network

  # Bridge Worker æœåŠ¡
  bridge-worker:
    image: node:22
    container_name: openclaw-bridge-worker
    
    # ä¾èµ– Bridge Server
    depends_on:
      http-bridge:
        condition: service_healthy
    
    # ç¯å¢ƒå˜é‡
    environment:
      - OPENCLAW_BRIDGE_URL=http://http-bridge:9848
      - OPENCLAW_POLL_INTERVAL=1.0
      - TAVILY_API_KEY=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
      - TAVILY_MCP_URL=https://mcp.tavily.com/mcp/
      - PYTHONUNBUFFERED=1
    
    # æŒ‚è½½å·
    volumes:
      - /mnt/e/work/wechatAGENT:/home/node/openclaw/wechat-agent:rw
      - /home/node/.openclaw:/home/node/.openclaw:rw
      - openclaw-node-modules:/home/node/openclaw/wechat-agent/node_modules
      - openclaw-pip-cache:/root/.cache/pip
    
    working_dir: /home/node/openclaw/wechat-agent
    
    # å¯åŠ¨å‘½ä»¤
    command: >
      sh -c "
        echo '========================================' &&
        echo '  OpenClaw Bridge Worker' &&
        echo '  è¿è¡Œåœ¨ Docker ä¸­' &&
        echo '========================================' &&
        echo '' &&
        echo 'â³ ç­‰å¾… Bridge Server å¯åŠ¨...' &&
        sleep 5 &&
        echo 'ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–...' &&
        apt-get update -qq &&
        apt-get install -y -qq python3 python3-pip curl 2>/dev/null &&
        echo '' &&
        echo 'ğŸ“¦ æ£€æŸ¥ Node.js (ç”¨äº MCP)...' &&
        which npx || (curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && apt-get install -y nodejs) &&
        node --version &&
        echo '' &&
        echo 'ğŸ“¦ å®‰è£… Python ä¾èµ–...' &&
        pip3 install -q aiohttp playwright html2text mcp 2>/dev/null &&
        echo '' &&
        echo 'ğŸ“¦ å®‰è£… Chromium...' &&
        playwright install chromium 2>/dev/null || echo 'âš ï¸ Chromium å¯èƒ½å·²å®‰è£…' &&
        echo '' &&
        echo 'ğŸš€ å¯åŠ¨ Bridge Worker...' &&
        echo '   Bridge URL: http://http-bridge:9848' &&
        echo '' &&
        python3 openclaw_bridge_worker.py
      "
    
    restart: unless-stopped
    
    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
    
    networks:
      - openclaw-network

networks:
  openclaw-network:
    driver: bridge

volumes:
  openclaw-node-modules:
  openclaw-pip-cache:
