# OpenClaw Bridge Worker Docker é…ç½®
# 
# ç”¨é€”: åœ¨ WSL Docker ä¸­è¿è¡Œ Bridge Worker
# è‡ªåŠ¨è¿æ¥åˆ°ä¸»æœºçš„ HTTP Bridge Server (ç«¯å£ 9848)

version: '3.8'

services:
  openclaw-worker:
    image: node:22
    container_name: openclaw-bridge-worker
    
    # ä½¿ç”¨ host ç½‘ç»œæ¨¡å¼ï¼Œå¯ä»¥ç›´æ¥è®¿é—®ä¸»æœºçš„ localhost
    network_mode: host
    
    # ç¯å¢ƒå˜é‡
    environment:
      - OPENCLAW_BRIDGE_URL=http://host.docker.internal:9848
      - OPENCLAW_POLL_INTERVAL=1.0
      - TAVILY_API_KEY=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
      - TAVILY_MCP_URL=https://mcp.tavily.com/mcp/
      - NODE_ENV=production
    
    # æŒ‚è½½å·
    volumes:
      # æŒ‚è½½ wechat-agent ä»£ç ç›®å½•
      - /mnt/e/work/wechatAGENT:/home/node/openclaw/wechat-agent:rw
      
      # æŒ‚è½½ OpenClaw å·¥ä½œç›®å½•
      - /home/node/.openclaw:/home/node/.openclaw:rw
      
      # æŒ‚è½½ Node.js ç¼“å­˜ï¼ˆåŠ é€Ÿï¼‰
      - openclaw-node-modules:/home/node/openclaw/wechat-agent/node_modules
      
      # æŒ‚è½½ Python ä¾èµ–ç¼“å­˜
      - openclaw-pip-cache:/root/.cache/pip
    
    # å·¥ä½œç›®å½•
    working_dir: /home/node/openclaw/wechat-agent
    
    # å¯åŠ¨å‘½ä»¤
    command: >
      sh -c "
        echo '========================================' &&
        echo '  OpenClaw Bridge Worker' &&
        echo '  è¿è¡Œåœ¨ Docker ä¸­' &&
        echo '========================================' &&
        echo '' &&
        echo 'ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–...' &&
        apt-get update -qq &&
        apt-get install -y -qq python3 python3-pip python3-venv curl 2>/dev/null &&
        echo '' &&
        echo 'ğŸ“¦ æ£€æŸ¥ Node.js (ç”¨äº MCP)...' &&
        which npx || (curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && apt-get install -y nodejs) &&
        echo 'âœ… Node.js: ' && node --version &&
        echo '' &&
        echo 'ğŸ“¦ å®‰è£… Python ä¾èµ–...' &&
        pip3 install -q aiohttp playwright html2text mcp 2>/dev/null || pip install aiohttp playwright html2text mcp &&
        echo '' &&
        echo 'ğŸ“¦ å®‰è£… Chromium...' &&
        playwright install chromium 2>/dev/null || echo 'âš ï¸ Chromium å¯èƒ½å·²å®‰è£…' &&
        echo '' &&
        echo 'ğŸš€ å¯åŠ¨ Bridge Worker...' &&
        echo '   Bridge URL: http://host.docker.internal:9848' &&
        echo '' &&
        cd /home/node/openclaw/wechat-agent &&
        python3 openclaw_bridge_worker.py
      "
    
    # è‡ªåŠ¨é‡å¯ç­–ç•¥
    restart: unless-stopped
    
    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

volumes:
  openclaw-node-modules:
  openclaw-pip-cache:
